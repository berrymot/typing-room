<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-time chat</title>
  <style>
    * {
      box-sizing: border-box;
    }

    @keyframes blink {
        from, to { border-color: black; }
        50% { border-color: transparent; }
    }

    html, body { height: 100%; margin: 0; }
    li { white-space: pre-wrap; }
    li span.cursor { animation: blink 1s step-end infinite; border-left: 1px solid black; margin-left: -1px; }
    li span.selected { color: white; background: blue; }

    body {
      background-color: #dfe;
      font-family: "Segoe UI", system-ui, "DejaVu Sans Mono", Tahoma, Verdana, Geneva, sans-serif;
    }

    .container {
      max-width: 60em;
      margin: auto;
      padding: 1em;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .messages {
      border: 1px solid teal;
      border-radius: 2px;
      background: white;
      flex: 1;
      overflow-y: scroll;
      display: flex;
      flex-direction: column;
    }

    .compose {
      display: flex;
      justify-content: stretch;
      height: 2em;
    }

    input {
      font-family: inherit;
      flex: 1;
    }

    .user-count {
      display: none;
    }

    .status.connected {
      color: green;
    }

    .status.disconnected {
      color: red;
    }

    .status.connected+.user-count {
      display: inline;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="settings">
      <h1>Typing room</h1>
      <p>
        This is a chat room where everyone can see messages as they're being composed.<br>
        Status: <b class="status">Not connected</b> <span class="user-count"></span>
      </p>
      <p>
        Pick a name to start chatting:
        <input autofocus class="name-input" onkeyup="changeName()" placeholder="Name" />
      </p>
    </div>
    <div class="messages">
      <ul class="message-list" style="flex: 1">
        <li><em>Submitted messages will appear here.</em></li>
      </ul>
    </div>
    <ul class="presence-list">
      <li><em>What others are typing will appear here.</em></li>
    </ul>
    <div class="compose">
      <input disabled placeholder="Type a message..." />
      <button type="button" onclick="send(true)">Submit</button>
    </div>
  </div>
  <script type="text/javascript">
    const compose = document.querySelector(".compose input");
    const stat = document.querySelector(".status");
    const url =
      new URLSearchParams(location.search).get("s") || location.hostname;
    const ws = new WebSocket(`ws://${url}:3434`);
    let buffers = {}; // { [id]: { text: string, pos: number } }
    const id = String(Math.random());
    let users = 0;

    ws.onopen = () => {
      stat.innerHTML = "Connected";
      stat.className = "status connected";
      ws.send(JSON.stringify({ login: id }));
    };
    ws.onclose = () => {
      stat.innerHTML = "Closed";
      stat.className = "status disconnected";
    };
    ws.onerror = () => {
      stat.innerHTML = "Error";
      stat.className = "status disconnected";
    };
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.submit) {
        const li = document.createElement("li");
        li.innerText = `<${msg.name}> ${msg.text}`;
        document.querySelector(".message-list").appendChild(li);
        buffers[msg.id] = null;
        renderBuffers();
      } else if (msg.users) {
        document.querySelector(".user-count").innerText = `(${msg.users} user${msg.users === 1 ? "" : "s"})`;
      } else if ("text" in msg) {
        buffers[msg.id] = msg;
        renderBuffers();
      } else if ("start" in msg) {
        const buffer = buffers[msg.id];
        if (buffer) { buffer.start = msg.start; buffer.end = msg.end; }
        renderBuffers();
      } else {
        console.warn("unrecognized", msg);
      }
    };
    function renderBuffers() {
      const presenceList = document.querySelector(".presence-list");
      const children = [];
      for (const msg of Object.values(buffers).sort()) {
        if (msg && msg.name && msg.text) {
          const start = msg.start;
          const end = msg.end;
          const li = document.createElement("li");
          li.innerText = `<${msg.name}> ${msg.text.slice(0, start)}`;
          const span = document.createElement("span");
          if (start === end) {
            span.innerText = msg.text.slice(start); span.className = "cursor";
            li.appendChild(span);
          } else {
            span.innerText = msg.text.slice(start, end); span.className = "selected";
            li.appendChild(span);
            const after = document.createElement("span");
            after.innerText = msg.text.slice(end);
            li.appendChild(after);
          }
          children.push(li);
        }
      }
      presenceList.replaceChildren(...children);
      document.querySelector(".messages").scrollTo(0, 9999);
    }
    function changeName() {
      const name = document.querySelector(".name-input").value;
      localStorage.setItem("name", name);
      compose.disabled = name === "";
      send(false);
    }
    function sendPos(start, end) {
      if (ws.readyState === 1) {
        ws.send(JSON.stringify({ id, name, start, end }));
      }
    }
    function send(submit) {
      if (ws.readyState === 1) {
        const name = document.querySelector(".name-input").value;
        const start = compose.selectionStart;
        const end = compose.selectionEnd;
        const text = compose.value;
        ws.send(JSON.stringify({ id, name, start, end, text, submit }));
        if (submit) {
          compose.value = "";
          compose.focus();
        }
      }
    }
    compose.addEventListener("keyup", (e) => {
      sendPos(compose.selectionStart, compose.selectionEnd);
      if (e.key === "Enter") send(true);
    });
    compose.addEventListener("input", (e) => {
      send(false);
    });
  </script>
</body>

</html>
